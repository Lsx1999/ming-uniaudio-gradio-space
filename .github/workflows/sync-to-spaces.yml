name: Sync to Hugging Face and ModelScope

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  sync-to-huggingface:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
          lfs: true

      - name: Sync to Hugging Face Space
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          # ã€è¯·ä¿®æ”¹ã€‘ä½ çš„ HF ç”¨æˆ·å
          HF_USERNAME: cafe3310
          # ã€è¯·ä¿®æ”¹ã€‘ä½ çš„ HF Space åç§°
          SPACE_NAME: ming-uniaudio-demo
          # ã€è¯·ä¿®æ”¹ã€‘è¦éƒ¨ç½²çš„æºç›®å½•ï¼ˆæ ¹ç›®å½•å¡« . ï¼Œå­ç›®å½•å¡«ç›®å½•åï¼‰
          SOURCE_DIR: gradio_app
        run: |
          echo "Cloning Hugging Face Space..."
          rm -rf /tmp/hf-space
          git clone https://$HF_USERNAME:$HF_TOKEN@huggingface.co/spaces/$HF_USERNAME/$SPACE_NAME /tmp/hf-space
          
          echo "Syncing files..."
          # ä½¿ç”¨ rsync åŒæ­¥ï¼Œ--delete ç¡®ä¿åˆ é™¤ GitHub ä¸Šå·²ç§»é™¤çš„æ–‡ä»¶
          rsync -av --delete \
            --exclude '.git/' \
            --exclude '.github/' \
            --exclude '.gitignore' \
            $SOURCE_DIR/ /tmp/hf-space/
          
          # ç¡®ä¿ LFS é…ç½®è¢«åŒæ­¥
          cp .gitattributes /tmp/hf-space/

          # åˆ›å»º Hugging Face å¿…é¡»çš„ README.md å…ƒæ•°æ®
          cat <<EOF > /tmp/hf-space/README.md
---
title: Ming UniAudio Demo
emoji: ğŸµ
colorFrom: indigo
colorTo: blue
sdk: gradio
sdk_version: 5.12.0
app_file: app.py
pinned: false
license: apache-2.0
short_description: Multi-modal audio generation and processing demo.
---

# Ming UniAudio Demo
This is a Gradio-based demo for the Ming UniAudio model.
EOF
            
          cd /tmp/hf-space
          # åˆå§‹åŒ– LFS
          git lfs install
          
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          
          git add .
          if git diff-index --quiet HEAD; then
            echo "No changes to commit."
          else
            git commit -m "Sync from GitHub: $(git rev-parse --short HEAD)"
            git push origin main
          fi

  sync-to-modelscope:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
          lfs: true

      - name: Sync to ModelScope Space
        env:
          MODELSCOPE_TOKEN: ${{ secrets.MODELSCOPE_TOKEN }}
          # ModelScope ç”¨æˆ·å
          MS_USERNAME: antsipan
          # ModelScope Space åç§°
          SPACE_NAME: ming-uniaudio-demo
          # è¦éƒ¨ç½²çš„æºç›®å½•
          SOURCE_DIR: gradio_app
        run: |
          echo "Cloning ModelScope Space..."
          rm -rf /tmp/ms-space
          # ModelScope Git åœ°å€æ ¼å¼
          git clone https://oauth2:$MODELSCOPE_TOKEN@www.modelscope.cn/studios/$MS_USERNAME/$SPACE_NAME.git /tmp/ms-space
          
          echo "Syncing files..."
          rsync -av --delete \
            --exclude '.git/' \
            --exclude '.github/' \
            --exclude '.gitignore' \
            $SOURCE_DIR/ /tmp/ms-space/

          cd /tmp/ms-space
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          
          git add .
          if git diff-index --quiet HEAD; then
            echo "No changes to commit."
          else
            git commit -m "Sync from GitHub: $(git rev-parse --short HEAD)"
            # æ³¨æ„ï¼šModelScope é»˜è®¤åˆ†æ”¯å¯èƒ½æ˜¯ masterï¼Œè¯·æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´
            git push origin master
          fi
